name: Reactjs CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  K8S_NAMESPACE: reactjs-boardgames
  K8S_SERVICE_NAME: reactjs-boardgames-service
  APP_NAME: reactjs-boardgames 
  WORKING_DIR: reactjs-boardgames
  PORT: 8282
  BRANCH_NAME: '' 

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      APP_NAME: ${{ env.APP_NAME }}
      WORKING_DIR: ${{ env.WORKING_DIR }}
      K8S_NAMESPACE: ${{ env.K8S_NAMESPACE }}
      K8S_SERVICE_NAME: ${{ env.K8S_SERVICE_NAME }}
      PORT: ${{ env.PORT }}
      TIMESTAMP: ${{ steps.set-timestamp.outputs.timestamp }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'

    - name: Install dependencies
      run: npm install
      working-directory: ./reactjs-boardgames

    - name: Build the project
      run: npm run build``
      working-directory: ./reactjs-boardgames

    - name: Run tests
      run: npm test
      working-directory: ./reactjs-boardgames

  call-build-image-push:
        uses: david-gimelle/lab/.github/workflows/build-image-push-to-ghcr.yml@main
        needs: build
        
        with:
          APP_NAME: ${{ needs.build.outputs.APP_NAME }}
          WORKING_DIR: ${{ needs.build.outputs.WORKING_DIR }}
          timestamp: ${{ needs.build.outputs.TIMESTAMP }}
        secrets:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}   
          
   #add a job to deploy this image to AKS
  deploy:
    runs-on: ubuntu-latest
    needs: call-build-image-push
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/k8s-set-context@v1
      with:
        kubeconfig: ${{ secrets.KUBE_CONFIG }}
        context: ${{ secrets.KUBE_CONTEXT }}
    
    - name: Call composite action to extract branch name
      id: extract-branch-name
      uses: david-gimelle/lab/.github/actions/extract-branch-name@main
  
    - name: Set branch name from composite action
      run: echo "BRANCH_NAME=${{ steps.extract-branch-name.outputs.branch_name }}" >> $GITHUB_ENV  
     
    #add a step to deploy the create the namespace
    - name: Create namespace
      run: kubectl create namespace ${{ env.K8S_NAMESPACE }}
      continue-on-error: true  
      
    - name: Create Docker registry secret
      run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GHCR_PAT }} \
            --docker-email=${{ github.actor }}@users.noreply.github.com \
            --namespace=${{ env.K8S_NAMESPACE }}

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f k8s/test/${{ env.APP_NAME }}.yml

    - name: Display full image name
      run: echo "Full image name ghcr.io/${{ github.repository }}/${{ env.APP_NAME }}:${{ env.BRANCH_NAME }}-${{ env.TIMESTAMP }}"    
